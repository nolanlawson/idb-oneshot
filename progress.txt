Phase 0: Project Scaffolding — COMPLETE
  - Created package.json (type: "module", better-sqlite3 + typescript deps)
  - Created tsconfig.json (strict, NodeNext, allowImportingTsExtensions)
  - Created CLAUDE.md with project conventions and commands
  - Created empty src/index.ts barrel export
  - Created .gitignore (node_modules, manifest, sqlite files)
  - Created test/wpt-harness-setup.ts (browser global shims for Node)
  - Created test/wpt-subprocess.ts (child process entry that loads testharness.js + test)
  - Created test/wpt-runner.ts (forks subprocess, parses JSON results, reports per-subtest)
  - Created test/run-all.ts (runs all .any.js files, generates manifest)
  - Verified: runner executes idbkeyrange.any.js, detects 10 subtests (all fail as expected - IDBKeyRange not yet implemented)
  - Verified: npx tsc --noEmit passes clean

Phase 1: IDBKeyRange + Key Validation + IDBFactory.cmp() — COMPLETE
  - Created src/types.ts (IDBKey, IDBValidKey type definitions)
  - Created src/errors.ts (DOMException helper factories for all IDB error types)
  - Created src/keys.ts (key validation via valueToKey/valueToKeyOrThrow, cross-type comparison via compareKeys, binary-comparable encoding via encodeKey)
  - Created src/IDBKeyRange.ts (only, lowerBound, upperBound, bound static methods + includes instance method)
  - Created src/IDBFactory.ts (cmp method; open/deleteDatabase/databases stubs for Phase 2)
  - Created src/DOMStringList.ts (length, item, contains, indexed access, Symbol.iterator)
  - Created stub classes: IDBRequest, IDBOpenDBRequest, IDBDatabase, IDBTransaction, IDBObjectStore, IDBIndex, IDBCursor, IDBCursorWithValue, IDBVersionChangeEvent
  - Updated src/index.ts barrel export with all classes
  - Updated test/wpt-harness-setup.ts to inject all IDB globals into test subprocess
  - WPT results (55/55 subtests passing):
    - idbkeyrange.any.js: 10/10 PASS
    - idbkeyrange-includes.any.js: 11/11 PASS
    - idbkeyrange_incorrect.any.js: 7/7 PASS
    - idbfactory_cmp.any.js: 12/12 PASS
    - historical.any.js: 15/15 PASS
  - key_valid.any.js, key_invalid.any.js, keyorder.any.js deferred to Phase 2 (require indexedDB.open)
  - npx tsc --noEmit passes clean

Phase 2: IDBFactory.open() + Database Lifecycle — COMPLETE
  - Created src/sqlite-backend.ts (SQLiteBackend class wrapping better-sqlite3: metadata DB, per-database files, CRUD for object stores/records/indexes, savepoint management)
  - Created src/scheduling.ts (queueTask via setTimeout(0) for async event dispatch)
  - Implemented src/IDBFactory.ts:
    - open(name, version): async open with version validation, upgrade transaction lifecycle, IDBVersionChangeEvent dispatch
    - deleteDatabase(name): async delete with versionchange notification to open connections, proper oldVersion tracking
    - databases(): returns list from metadata DB
    - Connection tracking for versionchange event dispatch (skips closed connections)
  - Implemented src/IDBDatabase.ts:
    - Connection properties: name, version, objectStoreNames (live from backend)
    - createObjectStore(): validates version change context, creates store in SQLite, updates transaction scope
    - deleteObjectStore(): validates context, deletes store and related records/indexes
    - transaction(): creates IDBTransaction with store name validation, auto-commit via microtask
    - close(): marks connection as closing to prevent new transactions
    - dispatchEvent override: wires on* handler properties to addEventListener pattern
  - Implemented src/IDBTransaction.ts:
    - Transaction lifecycle: active → inactive → committing → finished
    - objectStore(): SameObject-cached IDBObjectStore instances
    - abort(): rolls back SQLite savepoint, fires abort event, notifies DB for versionchange
    - commit()/auto-commit: releases savepoint, fires complete event
    - _createRequest(): creates IDBRequest with proper transaction binding
    - dispatchEvent override for on* handlers
    - Factory function pattern to break circular IDBObjectStore dependency
  - Implemented src/IDBObjectStore.ts:
    - CRUD operations: put(), add(), get(), getKey(), delete(), clear(), count()
    - Key path evaluation and injection for in-line keys
    - Auto-increment key generation
    - createIndex()/deleteIndex() for versionchange transactions
    - All operations fire events asynchronously via queueTask
  - Implemented src/IDBRequest.ts:
    - dispatchEvent override: temporarily registers on* handler as addEventListener listener for correct event.target
  - Updated src/IDBVersionChangeEvent.ts (unchanged, already working from Phase 1)
  - Updated src/types.ts: added global IDBTransactionMode type declaration
  - Updated src/index.ts: registers IDBObjectStore factory function to break circular dependency
  - Updated test/wpt-harness-setup.ts: added addEventListener/removeEventListener/dispatchEvent on globalThis for async test support
  - Updated test/wpt-subprocess.ts: added keepAliveInterval to prevent premature process exit during async tests
  - WPT results (90/92 subtests passing across Phase 1+2):
    Phase 1 (55/55 — unchanged):
    - idbkeyrange.any.js: 10/10 PASS
    - idbkeyrange-includes.any.js: 11/11 PASS
    - idbkeyrange_incorrect.any.js: 7/7 PASS
    - idbfactory_cmp.any.js: 12/12 PASS
    - historical.any.js: 15/15 PASS
    Phase 2 (35/37):
    - idbfactory_open.any.js: 28/29 PASS (1 fail requires cursor/index — Phase 4/5)
    - idbfactory-open-request-success.any.js: 1/1 PASS
    - idbfactory-open-request-error.any.js: 0/1 FAIL (requires unique index constraint — Phase 4)
    - idbfactory-open-error-properties.any.js: 1/1 PASS
    - idbfactory_deleteDatabase.any.js: 4/4 PASS
    - idbfactory-deleteDatabase-request-success.any.js: 1/1 PASS
    - idbversionchangeevent.any.js: 1/1 PASS
  - Deferred key tests now partially work with open():
    - key_valid.any.js: 14/18 (4 fail: Date/Infinity serialization — Phase 10 structured clone)
    - key_invalid.any.js: 33/34 (1 fail: Proxy array detection in put context)
    - keyorder.any.js: 12/24 (12 fail: require cursor — Phase 5)
  - npx tsc --noEmit passes clean

Phase 3: Object Store CRUD — COMPLETE
  - Implemented IDBKeyRange query support in get(), getKey(), delete(), count()
    - All methods now accept both exact keys and IDBKeyRange objects
    - Added queryToRange() helper for consistent key/range handling
    - Added getRecordInRange(), deleteRecordsInRange() to SQLiteBackend with _buildRangeQuery helper
    - count() now correctly filters by exact key or range
  - Implemented key path validation (isValidKeyPath/isValidKeyPathString)
    - createObjectStore now validates keyPath (SyntaxError for invalid paths)
    - createObjectStore rejects autoIncrement + empty string keyPath (InvalidAccessError)
    - createObjectStore rejects autoIncrement + array keyPath (InvalidAccessError)
    - createIndex validates keyPath
  - Fixed deleted object store detection
    - _ensureValid() now checks _deleted flag before every operation
    - deleteObjectStore() marks cached IDBObjectStore._deleted = true
    - All operations (add/put/get/getKey/delete/clear/count/createIndex/deleteIndex) throw InvalidStateError on deleted stores
  - Fixed getKey() argument validation
    - Throws TypeError when called with no arguments (per spec)
    - Returns decoded key from binary-encoded buffer for range queries
    - Added decodeKeyFromBuffer/decodeKeyAt for binary key decoding
  - Implemented unique index constraint enforcement
    - checkUniqueIndexConstraint() in SQLiteBackend checks for duplicate index keys
    - put/add check unique constraints before inserting and fire ConstraintError on violation
    - createIndex with unique:true aborts transaction if existing data violates constraint
  - Implemented index entry maintenance on put/add
    - deleteIndexEntriesForRecord() clears old entries before replacement
    - Adds new index entries for all indexes on the store after each put/add
    - Multi-entry index support: arrays are expanded into individual entries
    - _populateIndex() fills new index from existing records during createIndex
  - Improved index() stub to return proper NotFoundError for missing indexes
  - Fixed transaction auto-commit timing
    - Added _pendingRequestCount to IDBTransaction for accurate tracking
    - Separated _maybeAutoCommit() from _requestFinished() to avoid double-decrement
    - Nested requests during event handlers (e.g., count inside upgradeneeded) now work correctly
  - WPT results (93/102 subtests passing across Phase 3 target tests):
    - idbdatabase_createObjectStore.any.js: 26/27 PASS (1 fail: requires index() — Phase 4)
    - idbdatabase_deleteObjectStore.any.js: 3/3 PASS
    - idbobjectstore_add.any.js: 13/16 PASS (3 fail: require openCursor — Phase 5)
    - idbobjectstore_put.any.js: 13/16 PASS (3 fail: require openCursor — Phase 5)
    - idbobjectstore_get.any.js: 7/7 PASS
    - idbobjectstore_getKey.any.js: 17/17 PASS
    - idbobjectstore_delete.any.js: 7/7 PASS
    - idbobjectstore_clear.any.js: 2/4 PASS (2 fail: require openCursor/index — Phase 4/5)
    - idbobjectstore_count.any.js: 4/4 PASS
    - idbobjectstore_keyPath.any.js: 1/1 PASS
  - npx tsc --noEmit passes clean

Phase 4: Indexes — COMPLETE
  - Implemented full IDBIndex class (src/IDBIndex.ts):
    - Properties: name, objectStore, keyPath, unique, multiEntry
    - keyPath returns SameObject for array key paths
    - get(query): retrieves first record matching index key or range
    - getKey(query): retrieves first primary key matching index key or range
    - count(query): counts index entries, supports exact key and range queries
    - getAll/getAllKeys stubs (Phase 9)
    - openCursor/openKeyCursor stubs returning null (Phase 5)
    - _ensureValid() checks: deleted index, deleted-by-aborted-upgrade, deleted object store, inactive transaction
    - _createdInTransaction tracking for proper abort detection
  - Added SQLite backend index query methods (src/sqlite-backend.ts):
    - getRecordByIndexKey(): lookup record by exact index key with JOIN to records table
    - getRecordByIndexRange(): lookup first record in index key range
    - countIndexEntries(): count index entries with optional range filtering
  - Updated IDBObjectStore (src/IDBObjectStore.ts):
    - index() now returns real IDBIndex instances with SameObject caching
    - createIndex() returns real IDBIndex instances
    - createIndex() exception ordering: ConstraintError (name check) before SyntaxError (keyPath check)
    - createIndex() unique constraint violation: aborts transaction without throwing (returns IDBIndex)
    - deleteIndex() marks cached IDBIndex._deleted = true
    - Fixed multi-entry index entry generation: uses raw key path evaluation instead of valueToKey on arrays containing non-key elements
    - Same fix applied to _populateIndex for consistency
  - WPT results (33/34 Phase 4 subtests passing):
    - idbindex_get.any.js: 8/8 PASS
    - idbindex_getKey.any.js: 8/8 PASS
    - idbindex_count.any.js: 4/4 PASS
    - idbindex-multientry.any.js: 3/3 PASS
    - idbindex-objectStore-SameObject.any.js: 1/1 PASS
    - idbindex-request-source.any.js: 7/7 PASS
    - idbobjectstore_index.any.js: 1/1 PASS
    - idbindex_indexNames.any.js: 1/1 PASS
    - idbindex_keyPath.any.js: 1/3 (2 fail: require openCursor — Phase 5)
  - Bonus improvements from Phase 4 work:
    - idbfactory-open-request-error.any.js: now 1/1 PASS (was 0/1, needed unique index)
    - idbobjectstore_createIndex.any.js: 14/21 PASS (was 13/21, fixed ConstraintError ordering)
  - npx tsc --noEmit passes clean

Phase 5: Cursors — COMPLETE
  - Implemented full IDBCursor class (src/IDBCursor.ts):
    - Properties: key, primaryKey, direction, source, request
    - continue(key?): advance to next record, optional key target
    - advance(count): skip N records forward/backward
    - continuePrimaryKey(key, primaryKey): advance index cursor to specific key+primaryKey
    - update(value): update current record via cursor
    - delete(): delete current record via cursor
    - Proper cursor lifecycle: _gotValue/_continueCalled flags set asynchronously in event callback
    - Source validity checks (deleted store/index detection)
    - Request reuse: same IDBRequest fires success for each iteration
    - Request source set to cursor for update()/delete() per spec
  - Implemented IDBCursorWithValue (extends IDBCursor with value getter)
  - Added openObjectStoreCursor/openIndexCursor factory functions
  - Updated IDBObjectStore (src/IDBObjectStore.ts):
    - openCursor(query?, direction?): returns IDBCursorWithValue via IDBRequest
    - openKeyCursor(query?, direction?): returns IDBCursor (no value) via IDBRequest
    - Added Symbol.toStringTag for correct toString() output
    - Query validation moved before _createRequest to avoid polluting pending count on error
  - Updated IDBIndex (src/IDBIndex.ts):
    - openCursor(query?, direction?): opens cursor over index entries
    - openKeyCursor(query?, direction?): opens key-only cursor over index
    - Added Symbol.toStringTag
  - Added SQLite backend cursor methods (src/sqlite-backend.ts):
    - getRecordsForCursor(): retrieves sorted records within range for object store cursors
    - getIndexEntriesForCursor(): retrieves sorted index entries with JOIN for index cursors
    - Correct sort order for prevunique: index key DESC, primary key ASC
  - Fixed key encoding (src/keys.ts):
    - String encoding: added 0x00 0x00 terminator with NUL escape (0x00 0x01)
    - Binary encoding: added 0x00 0x00 terminator with byte stuffing
    - Added exported decodeKey() function, eliminating duplicated decoders in IDBObjectStore/IDBIndex
    - Array keys with string/binary elements now decode correctly
  - Added IDBCursorDirection global type declaration (src/types.ts)
  - WPT results (100/100 Phase 5 cursor subtests passing across 25 test files):
    - idbcursor-continue.any.js: 6/6 PASS
    - idbcursor-advance.any.js: 6/6 PASS
    - idbcursor-direction.any.js: 5/5 PASS
    - idbcursor-direction-index.any.js: 4/4 PASS
    - idbcursor-direction-objectstore.any.js: 4/4 PASS
    - idbcursor-direction-index-keyrange.any.js: 4/4 PASS
    - idbcursor-direction-objectstore-keyrange.any.js: 4/4 PASS
    - idbcursor-key.any.js: 3/3 PASS
    - idbcursor-primarykey.any.js: 3/3 PASS
    - idbcursor-source.any.js: 2/2 PASS
    - idbcursor-reused.any.js: 1/1 PASS
    - idbcursor-request.any.js: 4/4 PASS
    - idbcursor-request-source.any.js: 8/8 PASS
    - idbcursor_advance_index.any.js: 8/8 PASS
    - idbcursor_advance_objectstore.any.js: 5/5 PASS
    - idbcursor_continue_index.any.js: 10/10 PASS
    - idbcursor_continue_objectstore.any.js: 8/8 PASS
    - idbcursor_iterating.any.js: 1/1 PASS
    - cursor-overloads.any.js: 1/1 PASS
    - idbobjectstore_openCursor.any.js: 1/1 PASS
    - idbobjectstore_openCursor_invalid.any.js: 1/1 PASS
    - idbobjectstore_openKeyCursor.any.js: 5/5 PASS
    - idbindex_openCursor.any.js: 3/3 PASS
    - idbindex_openKeyCursor.any.js: 4/4 PASS
    - idbindex_reverse_cursor.any.js: 2/2 PASS
  - Bonus improvements from cursor support:
    - keyorder.any.js: now 24/24 PASS (was 12/24, needed cursor iteration)
    - idbdatabase_createObjectStore.any.js: now 27/27 PASS (was 26/27, needed index())
    - idbobjectstore_add.any.js: now 16/16 PASS (was 13/16, needed openCursor)
    - idbobjectstore_put.any.js: now 16/16 PASS (was 13/16, needed openCursor)
    - idbobjectstore_clear.any.js: now 4/4 PASS (was 2/4, needed openCursor/index)
    - idbindex_keyPath.any.js: now 3/3 PASS (was 1/3, needed openCursor)
  - npx tsc --noEmit passes clean

Phase 6: Transaction Lifecycle + Scheduling — COMPLETE
  - Created src/transaction-scheduler.ts (new file):
    - DatabaseScheduler class with per-database transaction queue
    - Scope-based locking: RW transactions block RW/RO with overlapping scopes
    - Creation order enforcement for conflicting transactions
    - Global scheduler map keyed by database name
    - Async start via queueMicrotask to avoid re-entrance
  - Major refactor: deferred SQLite operations via _queueOperation pattern
    - IDBObjectStore: all CRUD methods (add/put/get/getKey/delete/clear/count) defer both
      SQLite operations and event dispatch until scheduler starts the transaction
    - IDBIndex: get/getKey/count defer via same pattern
    - IDBCursor: openObjectStoreCursor/openIndexCursor defer via _queueOperation
    - Prevents savepoint nesting issues when transactions queue before active ones finish
  - Updated IDBTransaction (src/IDBTransaction.ts):
    - Added scheduler fields: _started, _pendingCallbacks, _useScheduler, _commitOnStart
    - _queueOperation(operation, eventCallback): buffers both when not started, executes immediately when started
    - _queueRequestCallback(callback): buffers just event callback when not started
    - _schedulerStart(): flushes buffered operations, triggers deferred auto-commit for empty transactions
    - abort/commit notify scheduler via getScheduler().transactionFinished()
    - Event bubbling: abort events bubble from transaction to database, respecting stopPropagation
  - Updated IDBDatabase (src/IDBDatabase.ts):
    - transaction() registers with scheduler via getScheduler().addTransaction()
    - Transaction deactivation via chained queueMicrotask (active through microtask checkpoint, inactive before next macrotask)
    - Store name deduplication via [...new Set(storeNames)]
    - Frozen objectStoreNames cache on close()
  - Updated IDBRequest (src/IDBRequest.ts):
    - Event bubbling: error events bubble from request to transaction to database, respecting stopPropagation/cancelBubble
    - Added Symbol.toStringTag to IDBOpenDBRequest
    - Added _constraintError flag for ConstraintError handling
  - Updated IDBObjectStore (src/IDBObjectStore.ts):
    - ConstraintError handling: unhandled error events auto-abort the transaction (per spec)
    - Error event dispatch returns notPrevented flag for abort decision
  - Updated IDBTransaction abort() for versionchange:
    - _versionChangeTransactionFinished fires in separate task after abort event propagates
  - WPT results (Phase 6 target tests):
    - transaction-scheduling-across-connections.any.js: 1/1 PASS (new)
    - transaction-scheduling-across-databases.any.js: 1/1 PASS (was passing)
    - transaction-scheduling-ordering.any.js: 1/1 PASS (new)
    - transaction-scheduling-rw-scopes.any.js: 1/1 PASS (new)
    - transaction-scheduling-mixed-scopes.any.js: 1/1 PASS (new)
    - transaction-scheduling-ro-waits-for-rw.any.js: 1/1 PASS (was passing)
    - transaction-scheduling-within-database.any.js: 1/1 PASS (was passing)
    - writer-starvation.any.js: 1/1 PASS (was passing)
    - idbtransaction.any.js: 2/2 PASS (was 1/2)
    - idbtransaction-oncomplete.any.js: 1/1 PASS (was passing)
    - idbtransaction_abort.any.js: 3/3 PASS (was 2/3)
    - idbtransaction_objectStoreNames.any.js: 7/8 PASS (was 4/8, remaining: unusual names SQLite issue)
    - transaction-deactivation-timing.any.js: 4/5 PASS (was 3/5, remaining: microtask between event listeners)
    - transaction-lifetime-empty.any.js: 2/2 PASS (was 0/2)
    - transaction-requestqueue.any.js: 1/1 PASS (was passing)
    - transaction-create_in_versionchange.any.js: 1/1 PASS (was passing)
    - upgrade-transaction-deactivation-timing.any.js: 3/3 PASS (bonus)
    - transaction-lifetime.any.js: 0/0 ERROR (needs blocked event + connection close)
    - open-request-queue.any.js: 0/0 ERROR (needs FIFO queue)
    - delete-request-queue.any.js: 0/1 FAIL (WPT test bug: this.saw vs saw)
  - No regressions in previously passing tests
  - Overall WPT pass rate: 688/1076 subtests (63.9%)
  - npx tsc --noEmit passes clean

Next: Phase 7 — Transaction Abort + Metadata Revert
